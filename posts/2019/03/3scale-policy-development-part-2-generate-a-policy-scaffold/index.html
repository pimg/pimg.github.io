<!doctype html>
<html lang="en-us">
  <head>
    <title>3scale policy development – part 2 generate a policy scaffold // API&#39;s you can trust</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.68.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="apily" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.e84ab12a6413c0736122e3b652a062e117a252e1a1ef3237ff703ae6990f7cdb.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="3scale policy development – part 2 generate a policy scaffold"/>
<meta name="twitter:description" content="In first part of our multi-part blog series about 3scale policy development we looked into the setup of a development environment. Now we have a functioning development environment we can start the actual development of the 3scale policy. In this part we will take a look and use the scaffolding utility provided by APIcast to generate a policy scaffold.
The first thing we are going to do is create a new git branch of the APIcast source we have cloned in the previous part."/>

    <meta property="og:title" content="3scale policy development – part 2 generate a policy scaffold" />
<meta property="og:description" content="In first part of our multi-part blog series about 3scale policy development we looked into the setup of a development environment. Now we have a functioning development environment we can start the actual development of the 3scale policy. In this part we will take a look and use the scaffolding utility provided by APIcast to generate a policy scaffold.
The first thing we are going to do is create a new git branch of the APIcast source we have cloned in the previous part." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://pimg.github.io/posts/2019/03/3scale-policy-development-part-2-generate-a-policy-scaffold/" />
<meta property="article:published_time" content="2019-03-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-03-22T00:00:00+00:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="http://pimg.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="apily" /></a>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
            <BR>
          
          <a class="app-header-menu-item" href="/about/">About</a>
            <BR>
          
          <a class="app-header-menu-item" href="/resume/">Resume</a>
            <BR>
          
          <a class="app-header-menu-item" href="/posts/">Blog</a>
            <BR>
          
          <a class="app-header-menu-item" href="/media/">In the media</a>
            <BR>
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
            <BR>
          
          <a class="app-header-menu-item" href="/services/">Training</a>
      </nav>
      <p>API&#39;s you can trust</p>
      <div class="app-header-social">
        
          <a href="https://github.com/pimg" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://nl.linkedin.com/in/pimgaemers" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">3scale policy development – part 2 generate a policy scaffold</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Mar 22, 2019
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="http://pimg.github.io/tags/3scale/">3scale</a>
              <a class="tag" href="http://pimg.github.io/tags/apicast/">apicast</a>
              <a class="tag" href="http://pimg.github.io/tags/apicast-policy/">apicast-policy</a>
              <a class="tag" href="http://pimg.github.io/tags/development/">development</a>
              <a class="tag" href="http://pimg.github.io/tags/lua/">lua</a>
              <a class="tag" href="http://pimg.github.io/tags/openresty/">openresty</a>
              <a class="tag" href="http://pimg.github.io/tags/policy/">policy</a>
              <a class="tag" href="http://pimg.github.io/tags/scaffold/">scaffold</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>In first part of our multi-part blog series about 3scale policy development we looked into the setup of a development environment. Now we have a functioning development environment we can start the actual development of the 3scale policy. In this part we will take a look and use the scaffolding utility provided by APIcast to generate a policy scaffold.</p>
<p>The first thing we are going to do is create a new git branch of the APIcast source we have cloned in the previous part. This is an optional step, but developing a new feature or changing code in general in a new branch is a good habit to get into. So create a new branch and start up our development container.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git checkout -b policy-development-blog
Switched to a new branch <span style="color:#e6db74">&#39;policy-development-blog&#39;</span>
$ make development
</code></pre></div><p>To generate the scaffold of our policy we can use the apicast utility located in the bin/ directory of our development container. So in the development container issue the following command:</p>
<p><strong>$ bin/apicast generate policy hello_world</strong></p>
<p>where hello_world is the name of the policy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-4.2$ bin/apicast generate policy hello_world
source: /home/centos/examples/scaffold/policy
destination: /home/centos
 
exists: t
created: t/apicast-policy-hello_world.t
exists: gateway
exists: gateway/src
exists: gateway/src/apicast
exists: gateway/src/apicast/policy
created: gateway/src/apicast/policy/hello_world
created: gateway/src/apicast/policy/hello_world/hello_world.lua
created: gateway/src/apicast/policy/hello_world/init.lua
created: gateway/src/apicast/policy/hello_world/apicast-policy.json
exists: spec
exists: spec/policy
created: spec/policy/hello_world
created: spec/policy/hello_world/hello_world_spec.lua
bash-4.2$
</code></pre></div><p>As you can see from the output of the generate policy command a few files have been created. These artifacts related to our policy are located in three different directories:</p>
<ul>
<li>t/ - this directory contains all Nginx integration tests</li>
<li>src/gateway/apicast/policy – this directory contains the source code and configuration schemas of all policies. Our policy resides in the subdirectory of hello_world</li>
<li>spec/policy - this directory contains the unit tests of all policies. The unit tests for our policy resides in the subdirectory of hello_world</li>
</ul>
<p>So the policy scaffolding utility not only generates a scaffold for our policy, but also the files for a configuration schema, unit tests and integration tests. Let’s have a look at these files.</p>
<p>The source code of our policy residing in the directory <em>src/gateway/apicast/policy/hello_world</em> contains three files.</p>
<ul>
<li>init.lua – all policies contain this init.lua file. It contains 1 line importing (require in Lua) our policy. It should not be modified.</li>
<li>aplicast-policy.json – The APIcast gateway is configured using a json document. Policies requiring configuration also use this json document. The apicast-policy.json file is a json schema file were configuration properties for the policy can be defined. We will look into configuration properties and this file in more detail in our next part of our policy development blog series.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;$schema&#34;</span>: <span style="color:#e6db74">&#34;http://apicast.io/policy-v1/schema#manifest#&#34;</span>,
  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;hello_world&#34;</span>,
  <span style="color:#f92672">&#34;summary&#34;</span>: <span style="color:#e6db74">&#34;TODO: write policy summary&#34;</span>,
  <span style="color:#f92672">&#34;description&#34;</span>: [
      <span style="color:#e6db74">&#34;TODO: Write policy description&#34;</span>
  ],
  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;builtin&#34;</span>,
  <span style="color:#f92672">&#34;configuration&#34;</span>: {
    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;object&#34;</span>,
    <span style="color:#f92672">&#34;properties&#34;</span>: { }
  }
}
</code></pre></div><ul>
<li>hello_world.lua – This is the actual source code of our policy, which at the moment does not contain much.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#75715e">-- This is a hello_world description.</span>
<span style="color:#66d9ef">local</span> policy <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;apicast.policy&#39;</span>)
<span style="color:#66d9ef">local</span> _M <span style="color:#f92672">=</span> policy.new(<span style="color:#e6db74">&#39;hello_world&#39;</span>)
<span style="color:#66d9ef">local</span> new <span style="color:#f92672">=</span> _M.new
<span style="color:#75715e">--- Initialize a hello_world</span>
<span style="color:#75715e">-- @tparam[opt] table config Policy configuration.</span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_M</span>.<span style="color:#a6e22e">new</span>(config)
  <span style="color:#66d9ef">local</span> self <span style="color:#f92672">=</span> new(config)
  <span style="color:#66d9ef">return</span> self
<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">return</span> _M
</code></pre></div><p> 
The first two lines import the APIcast policy module an instantiate a new policy with hello_world as an argument. This returns a module itself which is implemented using a Lua table. Lua is not an Object Oriented language from itself but tables (and especially metatables) can mimic objects. The third line stores a reference to a function new which is defined below. The new function takes a config variable as argument, but as of now nothing is done with is. The new method simply returns itself. Finally the module representing our policy is returned. This is done so other components importing this policy module retrieve the table and can invoke all functions and variables stored in the policy. We won’t cover all the files in details here since we are going to touch these in upcoming series when we flesh out our policy with functionality. But as a final verification to see if we have something working let’s run the unit tests again.</p>
<p><img src="images/make-busted-after-scaffold.png" alt=""></p>
<p>The keen observer can see the number of successes in the unit test outcome has increased from 749 to 751 after we generated the scaffold for our policy.</p>
<p>In the next part we will take a closer look at the json configuration schema file and how we can read the configuration values from the json configuration as well as ENV vars to use in our policy.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
